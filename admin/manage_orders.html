<!DOCTYPE html>
<html lang="vi">
<head>
Â  <meta charset="utf-8">
Â  <meta name="viewport" content="width=device-width,initial-scale=1">
Â  <title>Flora Admin - ÄÆ¡n hÃ ng</title>
Â  <link rel="stylesheet" href="assets/css/admin.css">
</head>

<body>

<aside class="sidebar">
Â  <h2><a href="../index.html" class="home-link">ğŸŒ¿ Flora Admin</a></h2>
Â  <ul>
Â  Â  <li><a href="dashboard.html">Tá»•ng quan</a></li>
Â  Â  <li><a href="manage_products.html">Sáº£n pháº©m</a></li>
Â  Â  <li><a href="manage_users.html">NgÆ°á»i dÃ¹ng</a></li>
Â  Â  <li><a href="manage_orders.html" class="active">ÄÆ¡n hÃ ng</a></li>
Â  Â  <li><a href="#" onclick="logout()">ÄÄƒng xuáº¥t</a></li>
Â  </ul>
</aside>

<main class="main">
Â  <h1>Quáº£n lÃ½ Ä‘Æ¡n hÃ ng</h1>

Â  <div class="revenue-summary">
Â  Â  <div class="revenue-card">
Â  Â  Â  <div class="icon">ğŸ’°</div>
Â  Â  Â  <div class="info">
Â  Â  Â  Â  <h3>Tá»•ng doanh thu</h3>
Â  Â  Â  Â  <p id="revenueValue">0Ä‘</p>
Â  Â  Â  Â  <span id="orderCount">(0 Ä‘Æ¡n hÃ ng)</span>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
    
  <div class="order-filter-controls">
    <label for="startDate">Tá»« ngÃ y:</label>
    <input type="date" id="startDate" name="startDate">
    
    <label for="endDate">Äáº¿n ngÃ y:</label>
    <input type="date" id="endDate" name="endDate">
    
    <button class="btn-main" onclick="filterOrders()">Lá»c ÄÆ¡n HÃ ng</button>
    <button class="btn-secondary" onclick="resetFilter()">Äáº·t láº¡i</button>
  </div>
  Â  <table id="orderTable">
Â  Â  <thead>
Â  Â  Â  <tr>
Â  Â  Â  Â  <th>ID</th>
Â  Â  Â  Â  <th>NgÆ°á»i Ä‘áº·t</th>
Â  Â  Â  Â  <th>NgÃ y</th>
Â  Â  Â  Â  <th>Tá»•ng tiá»n</th>
Â  Â  Â  Â  <th>Tráº¡ng thÃ¡i</th>
Â  Â  Â  Â  <th>HÃ nh Ä‘á»™ng</th>
Â  Â  Â  </tr>
Â  Â  </thead>
Â  Â  <tbody></tbody>
Â  </table>
</main>

<script src="assets/js/admin.js"></script>

<script>
Admin.requireAdmin();

// Biáº¿n lÆ°u trá»¯ táº¥t cáº£ Ä‘Æ¡n hÃ ng gá»‘c
let allOrders = Admin.getOrders();
// Biáº¿n lÆ°u trá»¯ cÃ¡c Ä‘Æ¡n hÃ ng Ä‘ang hiá»ƒn thá»‹ (sau khi lá»c)
let displayedOrders = [...allOrders]; 

const tbody = document.querySelector("#orderTable tbody");

/**
 * HÃ m chÃ­nh Ä‘á»ƒ hiá»ƒn thá»‹ dá»¯ liá»‡u lÃªn báº£ng
 * @param {Array} orderList - Danh sÃ¡ch Ä‘Æ¡n hÃ ng cáº§n hiá»ƒn thá»‹
 */
function render(orderList = displayedOrders) {
  displayedOrders = orderList; // Cáº­p nháº­t danh sÃ¡ch Ä‘ang hiá»ƒn thá»‹

Â  if (!displayedOrders.length) {
Â  Â  tbody.innerHTML = '<tr><td colspan="6">KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n hÃ ng nÃ o phÃ¹ há»£p.</td></tr>';
Â  Â  document.getElementById("revenueValue").textContent = "0Ä‘";
Â  Â  document.getElementById("orderCount").textContent = "(0 Ä‘Æ¡n hÃ ng)";
Â  Â  return;
Â  }

Â  let totalRevenue = 0;
Â  displayedOrders.forEach(o => {
Â  Â  // Giáº£ Ä‘á»‹nh tÃ­nh tá»•ng tiá»n tá»« items
Â  Â  const total = o.items.reduce((s, it) => s + (it.price * it.qty), 0);
Â  Â  totalRevenue += total;
Â  });

Â  document.getElementById("revenueValue").textContent =
Â  Â  totalRevenue.toLocaleString("vi-VN") + "Ä‘";

Â  document.getElementById("orderCount").textContent =
Â  Â  "(" + displayedOrders.length + " Ä‘Æ¡n hÃ ng)";

Â  tbody.innerHTML = displayedOrders.map((o, i) => {
Â  Â  const total = o.items.reduce((s, it) => s + (it.price * it.qty), 0);
    // Index i á»Ÿ Ä‘Ã¢y lÃ  index trong displayedOrders, khÃ´ng pháº£i allOrders.
Â  Â  return `
Â  Â  Â  <tr>
Â  Â  Â  Â  <td>${o.id}</td>
Â  Â  Â  Â  <td>${o.name}</td>
Â  Â  Â  Â  <td>${o.date}</td>
Â  Â  Â  Â  <td>${total.toLocaleString("vi-VN")}Ä‘</td>
Â  Â  Â  Â  <td>${o.status}</td>
Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  <button class="btn-edit" onclick="viewDetail(${i})">Xem</button>
Â  Â  Â  Â  Â  <button class="btn-edit" onclick="changeStatus(${i})">Sá»­a</button>
Â  Â  Â  Â  Â  <button class="btn-del" onclick="deleteOrder(${i})">XÃ³a</button>
Â  Â  Â  Â  </td>
Â  Â  Â  </tr>
Â  Â  `;
Â  }).join("");
}

/**
 * HÃ m lá»c Ä‘Æ¡n hÃ ng theo ngÃ y thÃ¡ng
 */
function filterOrders() {
    const startDateValue = document.getElementById('startDate').value;
    const endDateValue = document.getElementById('endDate').value;

    if (!startDateValue && !endDateValue) {
        // Náº¿u khÃ´ng cÃ³ ngÃ y nÃ o Ä‘Æ°á»£c chá»n, hiá»ƒn thá»‹ táº¥t cáº£
        render(allOrders);
        return;
    }

    // Chuyá»ƒn Ä‘á»•i ngÃ y thÃ¡ng nháº­p vÃ o thÃ nh Ä‘á»‘i tÆ°á»£ng Date
    // LÆ¯U Ã: TrÆ°á»ng 'date' trong Ä‘Æ¡n hÃ ng pháº£i lÃ  chuá»—i 'YYYY-MM-DD' Ä‘á»ƒ hoáº¡t Ä‘á»™ng Ä‘Ãºng.
    const startDate = startDateValue ? new Date(startDateValue) : null;
    let endDate = endDateValue ? new Date(endDateValue) : null;

    // Äiá»u chá»‰nh ngÃ y káº¿t thÃºc Ä‘á»ƒ bao gá»“m cáº£ ngÃ y Ä‘Ã³ (thÃªm 1 ngÃ y vÃ  trá»« 1ms)
    if (endDate) {
        endDate.setDate(endDate.getDate() + 1);
        endDate.setMilliseconds(endDate.getMilliseconds() - 1);
    }

    const filtered = allOrders.filter(order => {
        // Chuyá»ƒn Ä‘á»•i ngÃ y Ä‘Æ¡n hÃ ng thÃ nh Ä‘á»‘i tÆ°á»£ng Date (láº¥y tá»« trÆ°á»ng 'date' cá»§a Ä‘Æ¡n hÃ ng)
        const orderDate = new Date(order.date); 

        let matchesStart = true;
        let matchesEnd = true;

        if (startDate) {
            matchesStart = orderDate >= startDate;
        }

        if (endDate) {
            matchesEnd = orderDate <= endDate;
        }

        return matchesStart && matchesEnd;
    });

    render(filtered);
}

/**
 * HÃ m Ä‘áº·t láº¡i bá»™ lá»c vÃ  hiá»ƒn thá»‹ táº¥t cáº£ Ä‘Æ¡n hÃ ng
 */
function resetFilter() {
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    render(allOrders);
}

function viewDetail(i) {
Â  // Láº¥y Ä‘Æ¡n hÃ ng tá»« danh sÃ¡ch Ä‘ang hiá»ƒn thá»‹
Â  const o = displayedOrders[i]; 
Â  alert(`ÄÆ¡n #${o.id}
KhÃ¡ch: ${o.name}
NgÃ y: ${o.date}
Äá»‹a chá»‰: ${o.address}
Thanh toÃ¡n: ${o.payment}
Tráº¡ng thÃ¡i: ${o.status}`);
}

function changeStatus(i) {
Â  // TÃ¬m Ä‘Æ¡n hÃ ng gá»‘c trong allOrders báº±ng ID (vÃ¬ index i thay Ä‘á»•i khi lá»c)
  const orderToUpdate = allOrders.find(o => o.id === displayedOrders[i].id);
  if (!orderToUpdate) return;
  
Â  const newStatus = prompt("Nháº­p tráº¡ng thÃ¡i má»›i:", orderToUpdate.status);
Â  if (!newStatus) return;
Â  
  orderToUpdate.status = newStatus;
Â  Admin.setOrders(allOrders); // LÆ°u láº¡i toÃ n bá»™ danh sÃ¡ch Ä‘Ã£ chá»‰nh sá»­a
Â  
Â  // Cáº­p nháº­t láº¡i danh sÃ¡ch Ä‘ang hiá»ƒn thá»‹ (Ä‘á»ƒ duy trÃ¬ káº¿t quáº£ lá»c náº¿u cÃ³)
  displayedOrders = displayedOrders.map(o => o.id === orderToUpdate.id ? orderToUpdate : o);
Â  render();
}

function deleteOrder(i) {
Â  // TÃ¬m Ä‘Æ¡n hÃ ng gá»‘c trong allOrders báº±ng ID
  const orderToDelete = displayedOrders[i];
Â  if (!confirm(`Báº¡n cÃ³ cháº¯c muá»‘n XÃ“A Ä‘Æ¡n hÃ ng #${orderToDelete.id} khÃ´ng?`)) return;

Â  // XÃ³a khá»i danh sÃ¡ch gá»‘c (allOrders)
  const originalIndex = allOrders.findIndex(o => o.id === orderToDelete.id);
Â  if (originalIndex > -1) {
    allOrders.splice(originalIndex, 1);
    Admin.setOrders(allOrders); // LÆ°u láº¡i danh sÃ¡ch gá»‘c má»›i
  }
  
Â  // XÃ³a khá»i danh sÃ¡ch Ä‘ang hiá»ƒn thá»‹ (displayedOrders)
  displayedOrders.splice(i, 1);
Â  render();
}

// HÃ m Ä‘Æ°á»£c gá»i khi táº£i trang láº§n Ä‘áº§u
render(allOrders);
</script>


<script>
function logout() {
Â  localStorage.removeItem("isAdmin");
Â  location.href = "admin_login.html";
}
</script>

</body>
</html>